# Makefile for GoLangGraph Go-Agents-Simple Example
# Comprehensive build, test, and deployment automation

# Configuration
APP_NAME := go-agents-simple
VERSION := $(shell git describe --tags --always --dirty 2>/dev/null || echo "v0.1.0")
BUILD_TIME := $(shell date -u '+%Y-%m-%d_%H:%M:%S')
GIT_COMMIT := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
DOCKER_IMAGE := golanggraph/$(APP_NAME)
DOCKER_TAG := $(VERSION)
PORT := 8080
OLLAMA_PORT := 11434

# Go parameters
GOCMD := go
GOBUILD := $(GOCMD) build
GOCLEAN := $(GOCMD) clean
GOTEST := $(GOCMD) test
GOGET := $(GOCMD) get
GOMOD := $(GOCMD) mod
GOFMT := $(GOCMD) fmt
GOVET := $(GOCMD) vet

# Build flags
LDFLAGS := -ldflags "-X main.Version=$(VERSION) -X main.BuildTime=$(BUILD_TIME) -X main.GitCommit=$(GIT_COMMIT)"

# Default target
.PHONY: all
all: clean deps build test

# Help target
.PHONY: help
help:
	@echo "ğŸš€ GoLangGraph Go-Agents-Simple Makefile"
	@echo ""
	@echo "Available targets:"
	@echo "  ğŸ“¦ Build & Development:"
	@echo "    build         - Build the application"
	@echo "    clean         - Clean build artifacts"
	@echo "    deps          - Download dependencies"
	@echo "    tidy          - Tidy dependencies"
	@echo "    fmt           - Format code"
	@echo "    vet           - Run go vet"
	@echo "    lint          - Run linters"
	@echo ""
	@echo "  ğŸ§ª Testing:"
	@echo "    test          - Run tests"
	@echo "    test-verbose  - Run tests with verbose output"
	@echo "    test-coverage - Run tests with coverage"
	@echo "    benchmark     - Run benchmarks"
	@echo ""
	@echo "  ğŸƒ Running:"
	@echo "    run           - Run the application"
	@echo "    run-dev       - Run in development mode"
	@echo "    start-ollama  - Start Ollama service"
	@echo "    stop-ollama   - Stop Ollama service"
	@echo ""
	@echo "  ğŸ® Quick Play Commands:"
	@echo "    play          - Build and run locally (background)"
	@echo "    play-docker   - Build and run with Docker"
	@echo "    dev           - Clean, build, and run locally"
	@echo "    dev-docker    - Clean, build, and run with Docker"
	@echo "    stop-docker   - Stop Docker container"
	@echo "    quick-test    - Quick functionality test with Docker"
	@echo ""
	@echo "  ğŸ³ Docker:"
	@echo "    docker-build  - Build Docker image"
	@echo "    docker-run    - Run Docker container"
	@echo "    docker-stop   - Stop Docker container"
	@echo "    docker-push   - Push Docker image"
	@echo "    docker-clean  - Clean Docker images"
	@echo ""
	@echo "  ğŸš¢ Deployment:"
	@echo "    deploy-local  - Deploy minimal (app only)"
	@echo "    deploy-full   - Deploy with Redis and monitoring"
	@echo "    deploy-monitoring - Deploy with monitoring only"
	@echo "    deploy-stop   - Stop docker-compose deployment"
	@echo "    deploy-logs   - Show deployment logs"
	@echo ""
	@echo "  âœ… Validation:"
	@echo "    health-check  - Check application health"
	@echo "    test-endpoints- Test all API endpoints"
	@echo "    test-monitoring- Test monitoring stack (Prometheus + Grafana)"
	@echo "    smoke-test    - Run smoke tests"
	@echo ""
	@echo "  ğŸ§¹ Maintenance:"
	@echo "    update        - Update dependencies"
	@echo "    security      - Run security checks"
	@echo "    audit         - Audit dependencies"

# Build targets
.PHONY: build
build: deps
	@echo "ğŸ”¨ Building $(APP_NAME)..."
	@mkdir -p bin/
	GOWORK=off $(GOBUILD) $(LDFLAGS) -o bin/$(APP_NAME) .
	@echo "âœ… Build complete: bin/$(APP_NAME)"

.PHONY: clean
clean:
	@echo "ğŸ§¹ Cleaning..."
	$(GOCLEAN)
	rm -rf bin/
	rm -rf dist/
	rm -f coverage.out
	rm -f coverage.html
	@echo "âœ… Clean complete"

.PHONY: deps
deps:
	@echo "ğŸ“¦ Downloading dependencies..."
	$(GOGET) -d ./...
	@echo "âœ… Dependencies downloaded"

.PHONY: tidy
tidy:
	@echo "ğŸ”§ Tidying dependencies..."
	$(GOMOD) tidy
	@echo "âœ… Dependencies tidied"

.PHONY: fmt
fmt:
	@echo "âœ¨ Formatting code..."
	$(GOFMT) -w .
	@echo "âœ… Code formatted"

.PHONY: vet
vet:
	@echo "ğŸ” Running go vet..."
	$(GOVET) ./...
	@echo "âœ… Go vet complete"

.PHONY: lint
lint: fmt vet
	@echo "ğŸ” Running additional linters..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint not installed, skipping..."; \
	fi
	@echo "âœ… Linting complete"

# Testing targets
.PHONY: test
test:
	@echo "ğŸ§ª Running tests..."
	$(GOTEST) -v ./...
	@echo "âœ… Tests complete"

.PHONY: test-verbose
test-verbose:
	@echo "ğŸ§ª Running tests (verbose)..."
	$(GOTEST) -v -race ./...
	@echo "âœ… Verbose tests complete"

.PHONY: test-coverage
test-coverage:
	@echo "ğŸ§ª Running tests with coverage..."
	$(GOTEST) -v -coverprofile=coverage.out ./...
	$(GOCMD) tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report generated: coverage.html"

.PHONY: benchmark
benchmark:
	@echo "âš¡ Running benchmarks..."
	$(GOTEST) -bench=. -benchmem ./...
	@echo "âœ… Benchmarks complete"

# Running targets
.PHONY: run
run: build
	@echo "ğŸš€ Starting $(APP_NAME)..."
	./bin/$(APP_NAME)

.PHONY: run-dev
run-dev: deps
	@echo "ğŸš€ Starting $(APP_NAME) in development mode..."
	GOWORK=off $(GOCMD) run .

.PHONY: start-ollama
start-ollama:
	@echo "ğŸ¤– Starting Ollama..."
	@if ! pgrep ollama >/dev/null; then \
		ollama serve & \
		sleep 3; \
		echo "âœ… Ollama started"; \
	else \
		echo "â„¹ï¸  Ollama already running"; \
	fi
	@echo "ğŸ“¥ Pulling required models..."
	ollama pull llama3.2 || echo "âš ï¸  Failed to pull llama3.2"
	ollama pull gemma3:1b || echo "âš ï¸  Failed to pull gemma3:1b"

.PHONY: stop-ollama
stop-ollama:
	@echo "ğŸ›‘ Stopping Ollama..."
	@pkill ollama || echo "â„¹ï¸  Ollama not running"
	@echo "âœ… Ollama stopped"

# Docker targets
.PHONY: docker-build
docker-build:
	@echo "ğŸ³ Building Docker image..."
	cd ../../.. && docker build -f examples/10-ideation-agents/go-agents-simple/Dockerfile -t $(DOCKER_IMAGE):$(DOCKER_TAG) -t $(DOCKER_IMAGE):latest .
	@echo "âœ… Docker image built: $(DOCKER_IMAGE):$(DOCKER_TAG)"

.PHONY: docker-run
docker-run: docker-build
	@echo "ğŸ³ Running Docker container..."
	docker run -d --name $(APP_NAME) \
		-p $(PORT):8080 \
		--restart unless-stopped \
		$(DOCKER_IMAGE):$(DOCKER_TAG)
	@echo "âœ… Docker container running on http://localhost:$(PORT)"

.PHONY: docker-stop
docker-stop:
	@echo "ğŸ›‘ Stopping Docker container..."
	docker stop $(APP_NAME) || echo "Container not running"
	docker rm $(APP_NAME) || echo "Container not found"
	@echo "âœ… Docker container stopped"

.PHONY: docker-push
docker-push: docker-build
	@echo "ğŸ“¤ Pushing Docker image..."
	docker push $(DOCKER_IMAGE):$(DOCKER_TAG)
	docker push $(DOCKER_IMAGE):latest
	@echo "âœ… Docker image pushed"

.PHONY: docker-clean
docker-clean:
	@echo "ğŸ§¹ Cleaning Docker images..."
	docker rmi $(DOCKER_IMAGE):$(DOCKER_TAG) || true
	docker rmi $(DOCKER_IMAGE):latest || true
	docker system prune -f
	@echo "âœ… Docker cleanup complete"

# Deployment targets
.PHONY: deploy-local
deploy-local: docker-compose.yml
	@echo "ğŸš¢ Deploying locally with docker-compose (minimal)..."
	docker-compose up -d
	@echo "âœ… Local deployment running"
	@echo "ğŸŒ Web UI: http://localhost:$(PORT)/"
	@echo "ğŸ› API Playground: http://localhost:$(PORT)/playground"
	@echo "â¤ï¸  Health: http://localhost:$(PORT)/health"

.PHONY: deploy-full
deploy-full: docker-compose.yml
	@echo "ğŸš¢ Deploying with all services (Redis, Monitoring)..."
	docker-compose --profile full --profile monitoring up -d
	@echo "âœ… Full deployment running"
	@echo "ğŸŒ Web UI: http://localhost:$(PORT)/"
	@echo "ğŸ› API Playground: http://localhost:$(PORT)/playground"
	@echo "â¤ï¸  Health: http://localhost:$(PORT)/health"
	@echo "ğŸ“Š Prometheus: http://localhost:9091/"
	@echo "ğŸ“ˆ Grafana: http://localhost:3001/ (admin/admin)"
	@echo "ğŸ—„ï¸  Redis: localhost:6380"

.PHONY: deploy-monitoring
deploy-monitoring: docker-compose.yml
	@echo "ğŸš¢ Deploying with monitoring stack..."
	docker-compose --profile monitoring up -d
	@echo "âœ… Monitoring deployment running"
	@echo "ğŸŒ Web UI: http://localhost:$(PORT)/"
	@echo "ğŸ“Š Prometheus: http://localhost:9091/"
	@echo "ğŸ“ˆ Grafana: http://localhost:3001/ (admin/admin)"

.PHONY: deploy-stop
deploy-stop:
	@echo "ğŸ›‘ Stopping local deployment..."
	docker-compose down
	@echo "âœ… Local deployment stopped"

.PHONY: deploy-logs
deploy-logs:
	@echo "ğŸ“‹ Showing deployment logs..."
	docker-compose logs -f

# Validation targets
.PHONY: health-check
health-check:
	@echo "â¤ï¸  Checking application health..."
	@curl -f http://localhost:$(PORT)/health || echo "âŒ Health check failed"
	@echo "âœ… Health check complete"

.PHONY: test-endpoints
test-endpoints:
	@echo "ğŸ§ª Testing API endpoints..."
	@./scripts/test_endpoints.sh || echo "âŒ Endpoint tests failed"
	@echo "âœ… Endpoint tests complete"

.PHONY: test-monitoring
test-monitoring:
	@echo "ğŸ” Testing monitoring stack..."
	@./scripts/test_monitoring.sh || echo "âŒ Monitoring tests failed"
	@echo "âœ… Monitoring tests complete"

.PHONY: smoke-test
smoke-test: health-check
	@echo "ğŸ’¨ Running smoke tests..."
	@curl -s http://localhost:$(PORT)/agents | jq . || echo "âŒ Agents endpoint failed"
	@curl -s http://localhost:$(PORT)/capabilities | jq . || echo "âŒ Capabilities endpoint failed"
	@echo "âœ… Smoke tests complete"

# Maintenance targets
.PHONY: update
update:
	@echo "ğŸ”„ Updating dependencies..."
	$(GOGET) -u ./...
	$(GOMOD) tidy
	@echo "âœ… Dependencies updated"

.PHONY: security
security:
	@echo "ğŸ”’ Running security checks..."
	@if command -v gosec >/dev/null 2>&1; then \
		gosec ./...; \
	else \
		echo "âš ï¸  gosec not installed, skipping..."; \
	fi
	@echo "âœ… Security check complete"

.PHONY: audit
audit:
	@echo "ğŸ” Auditing dependencies..."
	$(GOMOD) download
	@if command -v nancy >/dev/null 2>&1; then \
		go list -json -m all | nancy sleuth; \
	else \
		echo "âš ï¸  nancy not installed, skipping vulnerability scan..."; \
	fi
	@echo "âœ… Audit complete"

# Special targets
.PHONY: install-tools
install-tools:
	@echo "ğŸ› ï¸  Installing development tools..."
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install github.com/securecodewarrior/nancy@latest
	go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
	@echo "âœ… Development tools installed"

# Quick development commands
.PHONY: dev
dev: clean build run
	@echo "ğŸ‰ Development cycle complete!"

.PHONY: dev-docker
dev-docker: clean docker-build docker-run
	@echo "ğŸ‰ Docker development cycle complete!"

.PHONY: play
play: clean build
	@echo "ğŸ® Starting play mode..."
	@echo "ğŸŒ Building and running application..."
	./bin/$(APP_NAME) &
	@sleep 3
	@echo ""
	@echo "ğŸ‰ Ready to play!"
	@echo "ğŸŒ Web UI: http://localhost:8080/"
	@echo "ğŸ› API Playground: http://localhost:8080/playground"
	@echo "â¤ï¸  Health: http://localhost:8080/health"
	@echo ""
	@echo "ğŸ’¡ Test commands:"
	@echo "   curl http://localhost:8080/health"
	@echo "   curl -X POST http://localhost:8080/api/designer -H 'Content-Type: application/json' -d '{\"message\": \"Design a treehouse\"}'"
	@echo ""
	@echo "ğŸ›‘ To stop: pkill $(APP_NAME)"

.PHONY: play-docker
play-docker: docker-build
	@echo "ğŸ® Starting Docker play mode..."
	@docker stop $(APP_NAME) 2>/dev/null || true
	@docker rm $(APP_NAME) 2>/dev/null || true
	@docker run --rm -d --name $(APP_NAME) \
		-p $(PORT):8080 \
		-e OLLAMA_ENDPOINT=http://host.docker.internal:11434 \
		--add-host host.docker.internal:host-gateway \
		$(DOCKER_IMAGE):$(DOCKER_TAG)
	@sleep 5
	@echo ""
	@echo "ğŸ‰ Docker ready to play!"
	@echo "ğŸŒ Web UI: http://localhost:$(PORT)/"
	@echo "ğŸ› API Playground: http://localhost:$(PORT)/playground"
	@echo "â¤ï¸  Health: http://localhost:$(PORT)/health"
	@echo ""
	@echo "ğŸ’¡ Test commands:"
	@echo "   curl http://localhost:$(PORT)/health"
	@echo "   curl -X POST http://localhost:$(PORT)/api/designer -H 'Content-Type: application/json' -d '{\"message\": \"Design a treehouse\"}'"
	@echo ""
	@echo "ğŸ›‘ To stop: make stop-docker"

.PHONY: stop-docker
stop-docker:
	@echo "ğŸ›‘ Stopping Docker play mode..."
	@docker stop $(APP_NAME) 2>/dev/null || echo "Container not running"
	@echo "âœ… Docker stopped"

.PHONY: quick-test
quick-test: play-docker
	@echo "ğŸ§ª Running quick functionality test..."
	@sleep 2
	@curl -f http://localhost:$(PORT)/health > /dev/null && echo "âœ… Health check passed" || echo "âŒ Health check failed"
	@curl -f -X POST http://localhost:$(PORT)/api/designer -H 'Content-Type: application/json' -d '{"message": "Quick test"}' > /dev/null && echo "âœ… Agent test passed" || echo "âŒ Agent test failed"
	@echo "ğŸ‰ Quick test complete!"

.PHONY: quick-start
quick-start: start-ollama build run

.PHONY: full-test
full-test: clean deps lint test test-coverage benchmark
	@echo "ğŸ‰ Full test suite complete!"

.PHONY: release
release: clean deps lint test docker-build
	@echo "ğŸš€ Release $(VERSION) ready!"
	@echo "ğŸ“¦ Binary: bin/$(APP_NAME)"
	@echo "ğŸ³ Docker: $(DOCKER_IMAGE):$(DOCKER_TAG)"
